<div class="product-detail-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i th√¥ng tin s·∫£n ph·∫©m...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <div class="error-icon">‚ùå</div>
    <h2>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h2>
    <p>{{ error }}</p>
    <button class="btn btn-primary" routerLink="/products">
      ‚Üê Quay l·∫°i danh s√°ch
    </button>
  </div>

  <!-- Product Content -->
  <div *ngIf="product && !loading" class="product-content">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a routerLink="/">Trang ch·ªß</a>
      <span>/</span>
      <a routerLink="/products">S·∫£n ph·∫©m</a>
      <span>/</span>
      <span class="current">{{ product.productName }}</span>
    </nav>

    <!-- ‚úÖ PH·∫¶N N√ÄY B·ªä THI·∫æU - Product Layout -->
    <div class="product-layout">
      <!-- Left: Image Gallery -->
      <div class="product-gallery">
        <div class="main-image">
          <img 
            [src]="product.imageUrl || 'https://via.placeholder.com/600'" 
            [alt]="product.productName">
          <div class="image-badges">
            <span class="badge badge-discount" *ngIf="product.discount && product.discount > 0">
              -{{ product.discount }}%
            </span>
            <span class="badge badge-new" *ngIf="isNewProduct()">
              M·ªõi
            </span>
          </div>
        </div>
        <div class="thumbnail-gallery">
          <div class="thumbnail active">
            <img [src]="product.imageUrl || 'https://via.placeholder.com/100'" 
                 [alt]="product.productName">
          </div>
        </div>
      </div>

      <!-- Right: Product Info -->
      <div class="product-info-section">
        <div class="product-header">
          <h1 class="product-title">{{ product.productName }}</h1>
          <div class="product-meta">
            <span class="category-badge">
              üì¶ {{ product.category?.categoryName }}
            </span>
            <span class="brand-badge">
              üè∑Ô∏è {{ product.brand?.brandName }}
            </span>
          </div>
        </div>

        <!-- Rating -->
        <div class="rating-section" *ngIf="product.ratingAvg">
          <div class="stars">
            {{ getStarDisplay(product.ratingAvg) }}
          </div>
          <span class="rating-value">{{ product.ratingAvg }}/5</span>
          <span class="review-count">({{ reviews.length }} ƒë√°nh gi√°)</span>
        </div>

        <!-- Price -->
        <div class="price-section">
          <div class="price-main">
            <span class="current-price">
              {{ formatPrice(calculateDiscountedPrice()) }}
            </span>
            <span class="original-price" *ngIf="product.discount && product.discount > 0">
              {{ formatPrice(product.price) }}
            </span>
          </div>
          <div class="savings" *ngIf="product.discount && product.discount > 0">
            Ti·∫øt ki·ªám: {{ formatPrice(product.price - calculateDiscountedPrice()) }}
          </div>
        </div>

        <!-- Stock Status -->
        <div class="stock-section">
          <div class="stock-status" [class.in-stock]="product.stockQuantity > 0"
                                    [class.low-stock]="product.stockQuantity > 0 && product.stockQuantity <= 10"
                                    [class.out-stock]="product.stockQuantity === 0">
            <span class="icon">
              {{ product.stockQuantity > 0 ? '‚úì' : '‚úó' }}
            </span>
            <span *ngIf="product.stockQuantity > 10">
              C√≤n h√†ng ({{ product.stockQuantity }} s·∫£n ph·∫©m)
            </span>
            <span *ngIf="product.stockQuantity > 0 && product.stockQuantity <= 10">
              S·∫Øp h·∫øt h√†ng (Ch·ªâ c√≤n {{ product.stockQuantity }} s·∫£n ph·∫©m)
            </span>
            <span *ngIf="product.stockQuantity === 0">
              H·∫øt h√†ng
            </span>
          </div>
        </div>

        <!-- Quantity Selector -->
        <div class="quantity-section" *ngIf="product.stockQuantity > 0">
          <label>S·ªë l∆∞·ª£ng:</label>
          <div class="quantity-controls">
            <button class="btn-quantity" (click)="decreaseQuantity()" [disabled]="quantity <= 1">
              ‚àí
            </button>
            <input type="number" 
                   [(ngModel)]="quantity" 
                   [min]="1" 
                   [max]="product.stockQuantity"
                   class="quantity-input">
            <button class="btn-quantity" (click)="increaseQuantity()" 
                    [disabled]="quantity >= product.stockQuantity">
              +
            </button>
          </div>
          <span class="quantity-hint">
            T·ªëi ƒëa: {{ product.stockQuantity }}
          </span>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn btn-primary btn-add-cart" 
                  (click)="addToCart()"
                  [disabled]="product.stockQuantity === 0 || addingToCart">
            <span *ngIf="!addingToCart">
              üõí Th√™m v√†o gi·ªè h√†ng
            </span>
            <span *ngIf="addingToCart">
              <span class="spinner-small"></span> ƒêang th√™m...
            </span>
          </button>
          <button class="btn btn-secondary btn-buy-now"
                  (click)="buyNow()"
                  [disabled]="product.stockQuantity === 0">
            ‚ö° Mua ngay
          </button>
        </div>

        <!-- Features -->
        <div class="features-section">
          <div class="feature-item">
            <span class="feature-icon">üöö</span>
            <div class="feature-text">
              <strong>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</strong>
              <small>ƒê∆°n h√†ng t·ª´ 500.000ƒë</small>
            </div>
          </div>
          <div class="feature-item">
            <span class="feature-icon">‚Ü©Ô∏è</span>
            <div class="feature-text">
              <strong>ƒê·ªïi tr·∫£ trong 7 ng√†y</strong>
              <small>N·∫øu c√≥ l·ªói t·ª´ nh√† s·∫£n xu·∫•t</small>
            </div>
          </div>
          <div class="feature-item">
            <span class="feature-icon">üîí</span>
            <div class="feature-text">
              <strong>Thanh to√°n b·∫£o m·∫≠t</strong>
              <small>Nhi·ªÅu h√¨nh th·ª©c thanh to√°n</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Description & Reviews -->
    <div class="product-description">
      <div class="tabs">
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'description'"
          (click)="changeTab('description')">
          M√¥ t·∫£ s·∫£n ph·∫©m
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'specifications'"
          (click)="changeTab('specifications')">
          Th√¥ng s·ªë k·ªπ thu·∫≠t
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'reviews'"
          (click)="changeTab('reviews')">
          ƒê√°nh gi√° ({{ reviews.length }})
        </button>
      </div>

      <div class="tab-content">
        <!-- Description Tab -->
        <div class="description-content" *ngIf="activeTab === 'description' && product">
          <h3>M√¥ t·∫£ chi ti·∫øt</h3>
          <p>{{ product.description || 'ƒêang c·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt s·∫£n ph·∫©m...' }}</p>
        </div>

        <!-- Specifications Tab -->
        <div class="specifications-content" *ngIf="activeTab === 'specifications' && product">
          <h3>Th√¥ng s·ªë k·ªπ thu·∫≠t</h3>
          <table class="specs-table">
            <tr>
              <td class="spec-label">Danh m·ª•c:</td>
              <td>{{ product.category?.categoryName || 'Ch∆∞a c·∫≠p nh·∫≠t' }}</td>
            </tr>
            <tr>
              <td class="spec-label">Th∆∞∆°ng hi·ªáu:</td>
              <td>{{ product.brand?.brandName || 'Ch∆∞a c·∫≠p nh·∫≠t' }}</td>
            </tr>
            <tr>
              <td class="spec-label">T√¨nh tr·∫°ng:</td>
              <td>{{ product.stockQuantity > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng' }}</td>
            </tr>
            <tr>
              <td class="spec-label">S·ªë l∆∞·ª£ng:</td>
              <td>{{ product.stockQuantity }} s·∫£n ph·∫©m</td>
            </tr>
          </table>
        </div>

        <!-- Reviews Tab -->
        <div class="reviews-content" *ngIf="activeTab === 'reviews'">
          <!-- Reviews Summary -->
          <div class="reviews-summary">
            <div class="summary-left">
              <div class="average-rating">
                <span class="rating-number">{{ getAverageRating().toFixed(1) }}</span>
                <div class="rating-stars">{{ getStarDisplay(getAverageRating()) }}</div>
                <span class="rating-count">{{ reviews.length }} ƒë√°nh gi√°</span>
              </div>
            </div>
            <div class="summary-right">
              <div class="rating-bar" *ngFor="let star of [5,4,3,2,1]">
                <span class="star-label">{{ star }} ‚≠ê</span>
                <div class="bar-container">
                  <div class="bar-fill" [style.width.%]="getRatingDistribution(star)"></div>
                </div>
                <span class="bar-percentage">{{ getRatingDistribution(star).toFixed(0) }}%</span>
              </div>
            </div>
          </div>

          <!-- Write Review Form -->
          <div class="write-review" *ngIf="currentUser">
            <h4>Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h4>
            
            <div class="review-form">
              <!-- Rating Stars -->
              <div class="rating-input">
                <label>ƒê√°nh gi√° c·ªßa b·∫°n:</label>
                <div class="star-rating">
                  <button 
                    *ngFor="let star of [1,2,3,4,5]" 
                    type="button"
                    class="star-button"
                    [class.active]="star <= newReview.rating"
                    (click)="setRating(star)">
                    ‚≠ê
                  </button>
                </div>
              </div>

              <!-- Comment -->
              <div class="comment-input">
                <label for="reviewComment">N·ªôi dung ƒë√°nh gi√°:</label>
                <textarea 
                  id="reviewComment"
                  [(ngModel)]="newReview.comment"
                  rows="4"
                  placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m..."
                  [disabled]="submittingReview"></textarea>
              </div>

              <!-- Error/Success Messages -->
              <div class="alert alert-error" *ngIf="reviewError">
                {{ reviewError }}
              </div>
              <div class="alert alert-success" *ngIf="reviewSuccess">
                {{ reviewSuccess }}
              </div>

              <!-- Submit Button -->
              <button 
                class="btn btn-primary"
                (click)="submitReview()"
                [disabled]="submittingReview || !newReview.comment.trim()">
                <span *ngIf="!submittingReview">G·ª≠i ƒë√°nh gi√°</span>
                <span *ngIf="submittingReview">
                  <span class="spinner-small"></span> ƒêang g·ª≠i...
                </span>
              </button>
            </div>
          </div>

          <!-- Login Prompt -->
          <div class="login-prompt" *ngIf="!currentUser">
            <p>Vui l√≤ng <a routerLink="/login" [queryParams]="{returnUrl: currentUrl}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ vi·∫øt ƒë√°nh gi√°</p>
          </div>

          <!-- Reviews List -->
          <div class="reviews-list">
            <h4>ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h4>
            
            <div *ngIf="loadingReviews" class="loading-reviews">
              <div class="spinner"></div>
              <p>ƒêang t·∫£i ƒë√°nh gi√°...</p>
            </div>

            <div *ngIf="!loadingReviews && reviews.length === 0" class="no-reviews">
              <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√° s·∫£n ph·∫©m n√†y!</p>
            </div>

            <div class="review-item" *ngFor="let review of reviews; trackBy: trackByReview">
              <div class="review-header">
                <div class="reviewer-info">
                  <span class="reviewer-avatar">üë§</span>
                  <div class="reviewer-details">
                    <span class="reviewer-name">{{ review.user?.fullName }}</span>
                    <span class="review-date">{{ formatDate(review.createdAt) }}</span>
                  </div>
                </div>
                <div class="review-rating">
                  {{ getStarDisplay(review.rating) }}
                </div>
              </div>
              <div class="review-body">
                <p>{{ review.comment }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    <div class="related-products">
      <h2>S·∫£n ph·∫©m t∆∞∆°ng t·ª±</h2>
      
      <div *ngIf="loadingRelated" class="loading-state">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i s·∫£n ph·∫©m li√™n quan...</p>
      </div>

      <div *ngIf="!loadingRelated && relatedProducts.length === 0" class="placeholder-card">
        <p>Kh√¥ng c√≥ s·∫£n ph·∫©m t∆∞∆°ng t·ª±</p>
      </div>

      <div class="products-grid" *ngIf="!loadingRelated && relatedProducts.length > 0">
        <div *ngFor="let relatedProduct of relatedProducts; trackBy: trackByProduct" class="product-card">
          <a [routerLink]="['/products', relatedProduct.productId]" class="product-link">
            <div class="product-image">
              <img 
                [src]="relatedProduct.imageUrl || 'https://via.placeholder.com/300'" 
                [alt]="relatedProduct.productName">
              <div class="product-badges">
                <span class="badge badge-discount" *ngIf="relatedProduct.discount && relatedProduct.discount > 0">
                  -{{ relatedProduct.discount }}%
                </span>
              </div>
            </div>

            <div class="product-info">
              <h3 class="product-name">{{ relatedProduct.productName }}</h3>
              <div class="product-brand">{{ relatedProduct.brand?.brandName }}</div>
              
              <div class="product-rating" *ngIf="relatedProduct.ratingAvg">
                <span class="stars">{{ getStarDisplay(relatedProduct.ratingAvg) }}</span>
                <span class="rating-value">{{ relatedProduct.ratingAvg }}</span>
              </div>

              <div class="product-price">
                <span class="current-price">
                  {{ formatPrice(relatedProduct.price * (1 - (relatedProduct.discount || 0) / 100)) }}
                </span>
                <span class="original-price" *ngIf="relatedProduct.discount && relatedProduct.discount > 0">
                  {{ formatPrice(relatedProduct.price) }}
                </span>
              </div>
            </div>
          </a>

          <div class="product-actions">
            <button 
              class="btn-add-cart" 
              (click)="addRelatedToCart($event, relatedProduct)"
              [disabled]="relatedProduct.stockQuantity === 0">
              <span *ngIf="relatedProduct.stockQuantity > 0">üõí Th√™m v√†o gi·ªè</span>
              <span *ngIf="relatedProduct.stockQuantity === 0">H·∫øt h√†ng</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div *ngIf="showSuccessToast" class="toast-notification success">
    ‚úì ƒê√£ th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!
  </div>
</div>